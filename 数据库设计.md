# 数据库设计

## 表结构设计

### 1. 用户表 (users)
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    device_id VARCHAR(64) UNIQUE NOT NULL COMMENT '设备唯一标识',
    username VARCHAR(50) UNIQUE COMMENT '用户名（可选）',
    nickname VARCHAR(50) COMMENT '昵称',
    avatar VARCHAR(255) COMMENT '头像URL',
    coins DECIMAL(10,2) DEFAULT 0 COMMENT '金币余额',
    total_coins DECIMAL(10,2) DEFAULT 0 COMMENT '历史总金币',
    level INT DEFAULT 1 COMMENT '用户等级',
    experience INT DEFAULT 0 COMMENT '经验值',
    game_count INT DEFAULT 0 COMMENT '游戏次数',
    best_score INT DEFAULT 0 COMMENT '最高分',
    last_login_time DATETIME COMMENT '最后登录时间',
    register_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    status TINYINT DEFAULT 1 COMMENT '状态：1正常，0禁用'
);
```

### 2. 广告配置表 (ad_configs)
```sql
CREATE TABLE ad_configs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT '广告名称',
    video_url VARCHAR(500) NOT NULL COMMENT '视频文件URL',
    duration INT NOT NULL COMMENT '视频时长（秒）',
    reward_coins DECIMAL(8,2) DEFAULT 0 COMMENT '观看奖励金币',
    daily_limit INT DEFAULT 10 COMMENT '每日观看限制',
    min_watch_duration INT DEFAULT 15 COMMENT '最少观看时长（秒）',
    weight INT DEFAULT 1 COMMENT '权重（用于随机选择）',
    status TINYINT DEFAULT 1 COMMENT '状态：1启用，0禁用',
    start_time DATETIME COMMENT '开始时间',
    end_time DATETIME COMMENT '结束时间',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 3. 广告观看记录表 (ad_watch_records)
```sql
CREATE TABLE ad_watch_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    ad_id INT NOT NULL,
    watch_duration INT NOT NULL COMMENT '实际观看时长（秒）',
    reward_coins DECIMAL(8,2) DEFAULT 0 COMMENT '获得金币',
    is_completed TINYINT DEFAULT 0 COMMENT '是否完整观看',
    ip_address VARCHAR(45) COMMENT 'IP地址',
    device_info TEXT COMMENT '设备信息',
    watch_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_date (user_id, DATE(watch_time)),
    INDEX idx_ad_date (ad_id, DATE(watch_time)),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (ad_id) REFERENCES ad_configs(id)
);
```

### 4. 系统配置表 (system_configs)
```sql
CREATE TABLE system_configs (
    id INT PRIMARY KEY AUTO_INCREMENT,
    config_key VARCHAR(50) UNIQUE NOT NULL,
    config_value TEXT NOT NULL,
    description VARCHAR(200) COMMENT '配置描述',
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 初始化配置数据
INSERT INTO system_configs (config_key, config_value, description) VALUES
('coin_to_rmb_rate', '1000', '金币兑换人民币比例（多少金币=1元）'),
('min_withdraw_amount', '10', '最小提现金额（元）'),
('max_withdraw_amount', '500', '最大提现金额（元）'),
('daily_ad_limit', '20', '每日广告观看上限'),
('game_reward_coins', '5', '完成一局游戏奖励金币'),
('register_reward_coins', '100', '注册奖励金币');
```

### 5. 金币流水表 (coin_transactions)
```sql
CREATE TABLE coin_transactions (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    type ENUM('ad_reward', 'game_reward', 'withdraw', 'register_reward', 'admin_adjust') NOT NULL,
    amount DECIMAL(10,2) NOT NULL COMMENT '金币数量（正数为收入，负数为支出）',
    balance_after DECIMAL(10,2) NOT NULL COMMENT '操作后余额',
    description VARCHAR(200) COMMENT '描述',
    related_id INT COMMENT '关联ID（如广告ID、游戏记录ID等）',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_time (user_id, created_time),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 6. 提现申请表 (withdraw_requests)
```sql
CREATE TABLE withdraw_requests (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    amount DECIMAL(8,2) NOT NULL COMMENT '提现金额（人民币）',
    coins_used DECIMAL(10,2) NOT NULL COMMENT '消耗金币数量',
    alipay_account VARCHAR(100) COMMENT '支付宝账号',
    real_name VARCHAR(50) COMMENT '真实姓名',
    status ENUM('pending', 'approved', 'rejected', 'completed') DEFAULT 'pending',
    admin_note TEXT COMMENT '管理员备注',
    request_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    process_time DATETIME COMMENT '处理时间',
    INDEX idx_user_status (user_id, status),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 7. 游戏记录表 (game_records)
```sql
CREATE TABLE game_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    score INT NOT NULL COMMENT '游戏得分',
    duration INT NOT NULL COMMENT '游戏时长（秒）',
    needles_inserted INT DEFAULT 0 COMMENT '成功插入针数',
    reward_coins DECIMAL(8,2) DEFAULT 0 COMMENT '奖励金币',
    play_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_score (user_id, score DESC),
    INDEX idx_score_time (score DESC, play_time DESC),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

### 8. 管理员表 (admins)
```sql
CREATE TABLE admins (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100) COMMENT '邮箱',
    role ENUM('super_admin', 'admin', 'operator') DEFAULT 'admin',
    last_login_time DATETIME,
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    status TINYINT DEFAULT 1 COMMENT '状态：1正常，0禁用'
);
```

## 索引优化

### 主要查询场景的索引
1. **用户每日广告观看次数查询**: `idx_user_date` on `ad_watch_records`
2. **用户金币流水查询**: `idx_user_time` on `coin_transactions`
3. **游戏排行榜查询**: `idx_score_time` on `game_records`
4. **提现申请管理**: `idx_user_status` on `withdraw_requests`

## 数据特点

1. **读写比例**: 读多写少，适合使用缓存优化
2. **数据增长**: 游戏记录和广告记录会快速增长，需要定期清理
3. **实时性要求**: 金币余额需要强一致性，其他数据可接受最终一致性 