# 🔐 管理员登录系统说明

## 默认管理员账号

```
用户名: admin
密码:   admin123
```

⚠️ **重要提示**：首次登录后请尽快修改密码！

---

## 访问地址

### 登录页面
```
http://your-domain/admin/login
```

### 管理后台
```
http://your-domain/admin/
```

如果未登录访问管理后台，会自动跳转到登录页面。

---

## 功能说明

### 1. 登录功能
- ✅ 用户名密码验证
- ✅ Session管理（24小时有效期）
- ✅ HttpOnly Cookie保护
- ✅ 密码SHA256加密存储
- ✅ 登录失败提示
- ✅ 登录成功自动跳转

### 2. 登出功能
- 在任何管理后台页面，点击右上角 **🚪 登出** 按钮
- 确认后会清除Session并跳转到登录页

### 3. Session保护
- Session有效期：24小时
- 24小时后需要重新登录
- 登出后Session立即失效

---

## 系统架构

### 认证流程

```
1. 用户访问 /admin/login
   ↓
2. 输入用户名和密码
   ↓
3. POST /admin/api/login
   ↓
4. 验证用户名和密码（SHA256）
   ↓
5. 创建Session并设置Cookie
   ↓
6. 跳转到 /admin/
```

### Session管理

```python
# Session存储结构
admin_sessions = {
    "session_id_xxxxx": {
        "admin_id": 1,
        "created_at": datetime(2025, 10, 11, ...)
    }
}
```

- **Session ID**: 32字节安全随机字符串
- **存储方式**: 内存（生产环境建议用Redis）
- **过期检查**: 每次请求自动检查

### 密码加密

```python
import hashlib

password_hash = hashlib.sha256(password.encode()).hexdigest()
```

- 算法: SHA256
- 存储: 64字符十六进制字符串
- 示例: `admin123` → `240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9`

---

## 管理员账号管理

### 创建新管理员

#### 方法1: 使用初始化脚本
```bash
cd backend
python init_admin.py
```

#### 方法2: 直接操作数据库
```sql
-- 生成密码哈希（使用Python）
-- python -c "import hashlib; print(hashlib.sha256('your_password'.encode()).hexdigest())"

INSERT INTO admins (username, password_hash, email, role, status, created_time)
VALUES (
    'newadmin',
    'password_hash_here',
    'newadmin@example.com',
    'admin',
    1,
    NOW()
);
```

### 修改密码

#### 使用脚本重置
```bash
cd backend
python init_admin.py
# 选择 'y' 重置密码
```

#### 使用SQL
```sql
-- 生成新密码的哈希值
UPDATE admins 
SET password_hash = '新密码的SHA256哈希值' 
WHERE username = 'admin';
```

### 查看所有管理员
```sql
SELECT id, username, email, role, status, last_login_time, created_time 
FROM admins;
```

### 禁用管理员
```sql
UPDATE admins SET status = 0 WHERE username = 'admin';
```

### 启用管理员
```sql
UPDATE admins SET status = 1 WHERE username = 'admin';
```

---

## 安全建议

### ⚠️ 生产环境必须做的事

1. **修改默认密码**
   ```
   默认密码 admin123 太简单，必须改成强密码
   ```

2. **使用HTTPS**
   ```
   确保使用SSL证书，否则Cookie可能被窃取
   ```

3. **Session存储改为Redis**
   ```python
   # 当前使用内存存储，重启会丢失
   # 生产环境建议用Redis
   import redis
   r = redis.Redis(host='localhost', port=6379, db=0)
   ```

4. **限制登录尝试次数**
   ```
   防止暴力破解，建议添加：
   - 同一IP 5分钟内最多尝试5次
   - 验证码（可选）
   ```

5. **日志审计**
   ```
   记录所有管理员操作：
   - 登录时间
   - 操作记录
   - IP地址
   ```

---

## 文件清单

### 新增/修改的文件

1. **登录页面**
   ```
   backend/templates/admin/login.html
   ```

2. **路由文件**
   ```
   backend/routers/admin_router.py
   - 添加了登录/登出API
   - 修改了Session验证逻辑
   ```

3. **初始化脚本**
   ```
   backend/init_admin.py
   - 创建默认管理员
   - 重置密码功能
   ```

4. **启动文件**
   ```
   backend/main.py
   - 自动创建默认管理员
   ```

5. **管理后台页面**
   ```
   backend/templates/admin/dashboard.html
   backend/templates/admin/withdraw_management.html
   - 添加了登出按钮
   ```

---

## 常见问题

### Q1: 忘记密码怎么办？
```bash
cd backend
python init_admin.py
# 选择 'y' 重置为 admin123
```

### Q2: 为什么登录后还是跳转到登录页？
可能原因：
1. Cookie被浏览器阻止 → 检查浏览器设置
2. Session过期（24小时）→ 重新登录
3. 跨域问题 → 检查CORS配置

### Q3: 可以创建多个管理员吗？
可以！使用SQL直接插入或修改 `init_admin.py` 脚本。

### Q4: Session什么时候过期？
- 创建后24小时自动过期
- 手动登出立即过期
- 服务器重启后全部过期（内存存储）

### Q5: 如何查看当前登录的管理员？
检查Cookie中的 `admin_session` 值，然后在后端：
```python
session_data = admin_sessions.get(session_id)
admin_id = session_data['admin_id'] if session_data else None
```

---

## 数据库表结构

### admins 表
```sql
CREATE TABLE `admins` (
  `id` int NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL,
  `password_hash` varchar(255) NOT NULL,
  `email` varchar(100) DEFAULT NULL,
  `role` enum('super_admin','admin','operator') DEFAULT 'admin',
  `last_login_time` datetime DEFAULT NULL,
  `created_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `status` int DEFAULT '1' COMMENT '状态：1正常，0禁用',
  PRIMARY KEY (`id`),
  UNIQUE KEY `username` (`username`)
);
```

### 管理员角色说明
- `super_admin`: 超级管理员（所有权限）
- `admin`: 普通管理员（大部分权限）
- `operator`: 操作员（有限权限）

*注：当前版本暂未实现角色权限控制，所有角色权限相同*

---

## 测试步骤

1. **启动后端服务**
   ```bash
   cd backend
   python main.py
   ```

2. **访问登录页**
   ```
   http://localhost:3000/admin/login
   ```

3. **输入默认账号**
   ```
   用户名: admin
   密码: admin123
   ```

4. **登录成功**
   - 应该跳转到 `/admin/`
   - 右上角显示 "👤 管理员" 和 "🚪 登出" 按钮

5. **测试登出**
   - 点击 "🚪 登出"
   - 确认后跳转到登录页

6. **测试保护**
   - 登出后访问 `/admin/`
   - 应该自动跳转到 `/admin/login`

---

## 技术栈

- **前端**: HTML5 + CSS3 + JavaScript (原生)
- **后端**: FastAPI + Python 3.8+
- **数据库**: MySQL 5.7+
- **Session**: 内存存储（可升级为Redis）
- **加密**: SHA256

---

## 下一步改进建议

1. ✅ 基础登录认证 ←  **已完成**
2. ⏳ 角色权限控制（RBAC）
3. ⏳ 操作日志记录
4. ⏳ 密码强度要求
5. ⏳ 双因素认证（2FA）
6. ⏳ 登录失败限制
7. ⏳ Session迁移到Redis
8. ⏳ JWT Token支持

---

需要帮助？请检查以下文件的日志输出：
- 后端控制台输出
- 浏览器开发者工具 → Console
- 浏览器开发者工具 → Network

🎉 管理员登录系统已成功部署！

