<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>版本管理 - 见缝插针管理后台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .content-area {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .stats-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .version-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        .upload-area.dragover {
            border-color: #28a745;
            background-color: #f0fff4;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">管理后台</h4>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/">
                                <i class="bi bi-house-door me-2"></i>
                                数据概览
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/users">
                                <i class="bi bi-people me-2"></i>
                                用户管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/ads">
                                <i class="bi bi-play-circle me-2"></i>
                                广告管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/withdraw">
                                <i class="bi bi-cash-coin me-2"></i>
                                提现管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/admin/levels">
                                <i class="bi bi-trophy me-2"></i>
                                等级管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white active bg-primary rounded" href="/admin/versions">
                                <i class="bi bi-arrow-up-circle me-2"></i>
                                版本管理
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区域 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 content-area">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">版本管理</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVersionModal">
                            <i class="bi bi-plus-circle me-2"></i>发布新版本
                        </button>
                    </div>
                </div>

                <!-- 统计卡片 -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="bi bi-phone text-success" style="font-size: 2rem;"></i>
                                <h5 class="card-title mt-2">Android版本</h5>
                                <h3 class="text-success" id="androidVersionCount">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="bi bi-apple text-info" style="font-size: 2rem;"></i>
                                <h5 class="card-title mt-2">iOS版本</h5>
                                <h3 class="text-info" id="iosVersionCount">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="bi bi-check-circle text-primary" style="font-size: 2rem;"></i>
                                <h5 class="card-title mt-2">活跃版本</h5>
                                <h3 class="text-primary" id="activeVersionCount">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="bi bi-collection text-warning" style="font-size: 2rem;"></i>
                                <h5 class="card-title mt-2">总版本数</h5>
                                <h3 class="text-warning" id="totalVersionCount">-</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 版本列表 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">版本列表</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>版本名称</th>
                                        <th>版本号</th>
                                        <th>平台</th>
                                        <th>文件大小</th>
                                        <th>强制更新</th>
                                        <th>状态</th>
                                        <th>发布时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="versionTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 添加版本模态框 -->
    <div class="modal fade" id="addVersionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">发布新版本</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addVersionForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">版本名称</label>
                                    <input type="text" class="form-control" name="version_name" placeholder="如: 1.0.0" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">版本号</label>
                                    <input type="number" class="form-control" name="version_code" placeholder="递增整数" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">平台</label>
                            <select class="form-select" name="platform" required>
                                <option value="">选择平台</option>
                                <option value="android">Android</option>
                                <option value="ios">iOS</option>
                            </select>
                        </div>

                        <!-- APK上传区域 -->
                        <div class="mb-3">
                            <label class="form-label">APK文件</label>
                            <div class="upload-area" id="uploadArea">
                                <i class="bi bi-cloud-upload" style="font-size: 3rem; color: #6c757d;"></i>
                                <p class="mt-2 mb-0">点击选择文件或拖拽文件到此处</p>
                                <p class="text-muted small">支持 .apk 文件</p>
                                <input type="file" id="apkFileInput" accept=".apk" style="display: none;">
                            </div>
                            <div id="uploadProgress" class="mt-2" style="display: none;">
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <input type="hidden" name="download_url" id="downloadUrl">
                            <input type="hidden" name="file_size" id="fileSize">
                            <input type="hidden" name="file_name" id="fileName">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">更新内容</label>
                            <textarea class="form-control" name="update_content" rows="4" placeholder="每行一个更新点"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="is_force_update" value="1">
                                        <label class="form-check-label">强制更新</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">最低支持版本号</label>
                                    <input type="number" class="form-control" name="min_support_version" placeholder="可选">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitVersion()">发布版本</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 页面加载时获取数据
        document.addEventListener('DOMContentLoaded', function() {
            loadVersionStats();
            loadVersionList();
            setupFileUpload();
        });

        // 加载版本统计
        function loadVersionStats() {
            fetch('/api/version-stats')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        const stats = data.data;
                        document.getElementById('androidVersionCount').textContent = stats.android_versions;
                        document.getElementById('iosVersionCount').textContent = stats.ios_versions;
                        document.getElementById('activeVersionCount').textContent = stats.active_versions;
                        document.getElementById('totalVersionCount').textContent = stats.total_versions;
                    }
                })
                .catch(error => console.error('加载统计数据失败:', error));
        }

        // 加载版本列表
        function loadVersionList() {
            fetch('/api/versions')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        renderVersionTable(data.data);
                    }
                })
                .catch(error => console.error('加载版本列表失败:', error));
        }

        // 渲染版本表格
        function renderVersionTable(versions) {
            const tbody = document.getElementById('versionTableBody');
            if (versions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">暂无版本数据</td></tr>';
                return;
            }

            tbody.innerHTML = versions.map(version => `
                <tr>
                    <td>${version.version_name}</td>
                    <td><span class="badge bg-secondary">${version.version_code}</span></td>
                    <td>
                        <i class="bi bi-${version.platform === 'android' ? 'phone' : 'apple'} me-1"></i>
                        ${version.platform.charAt(0).toUpperCase() + version.platform.slice(1)}
                    </td>
                    <td>${version.file_size ? formatFileSize(version.file_size) : '-'}</td>
                    <td>
                        <span class="badge ${version.is_force_update ? 'bg-danger' : 'bg-success'}">
                            ${version.is_force_update ? '是' : '否'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${version.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                            ${version.status === 'active' ? '活跃' : '停用'}
                        </span>
                    </td>
                    <td>${version.publish_time ? new Date(version.publish_time).toLocaleString() : '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editVersion(${version.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteVersion(${version.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 设置文件上传
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('apkFileInput');

            uploadArea.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', handleFileSelect);

            // 拖拽上传
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
        }

        // 处理文件选择
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        }

        // 处理文件上传
        function handleFileUpload(file) {
            if (!file.name.endsWith('.apk')) {
                alert('请选择APK文件');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = progressDiv.querySelector('.progress-bar');
            
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';

            fetch('/api/upload-apk', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    document.getElementById('downloadUrl').value = data.data.download_url;
                    document.getElementById('fileSize').value = data.data.file_size;
                    document.getElementById('fileName').value = data.data.file_name;
                    
                    document.getElementById('uploadArea').innerHTML = `
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                        <p class="mt-2 mb-0 text-success">上传成功</p>
                        <p class="text-muted small">${data.data.original_name}</p>
                    `;
                    progressBar.style.width = '100%';
                } else {
                    alert('上传失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('上传失败:', error);
                alert('上传失败');
            })
            .finally(() => {
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);
            });
        }

        // 提交版本
        function submitVersion() {
            const form = document.getElementById('addVersionForm');
            const formData = new FormData(form);
            
            const versionData = {
                version_name: formData.get('version_name'),
                version_code: parseInt(formData.get('version_code')),
                platform: formData.get('platform'),
                download_url: formData.get('download_url'),
                file_size: parseInt(formData.get('file_size')) || null,
                file_name: formData.get('file_name'),
                update_content: formData.get('update_content'),
                is_force_update: formData.get('is_force_update') ? 1 : 0,
                min_support_version: parseInt(formData.get('min_support_version')) || null,
                publish_time: new Date().toISOString()
            };

            if (!versionData.download_url) {
                alert('请先上传APK文件');
                return;
            }

            fetch('/api/versions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(versionData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert('版本发布成功');
                    bootstrap.Modal.getInstance(document.getElementById('addVersionModal')).hide();
                    form.reset();
                    loadVersionStats();
                    loadVersionList();
                } else {
                    alert('发布失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('发布失败:', error);
                alert('发布失败');
            });
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // 编辑版本
        function editVersion(id) {
            alert('编辑功能待实现');
        }

        // 删除版本
        function deleteVersion(id) {
            if (confirm('确定要删除这个版本吗？')) {
                fetch(`/api/versions/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('删除成功');
                        loadVersionStats();
                        loadVersionList();
                    } else {
                        alert('删除失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('删除失败:', error);
                    alert('删除失败');
                });
            }
        }
    </script>
</body>
</html>
