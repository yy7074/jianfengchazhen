# IPå°ç¦åŒæ­¥åŠŸèƒ½è¯´æ˜Ž

## ðŸ“‹ é—®é¢˜è¯´æ˜Ž

ç³»ç»Ÿä¸­IPå°ç¦æ¥æºæœ‰ä¸¤ä¸ªï¼š
1. **æ•°æ®åº“ (ip_blacklistè¡¨)** - åº”ç”¨ç¨‹åºè‡ªåŠ¨å°ç¦æˆ–ç®¡ç†å‘˜æ‰‹åŠ¨æ·»åŠ 
2. **UFWé˜²ç«å¢™** - ç³»ç»Ÿçº§é˜²ç«å¢™è§„åˆ™å°ç¦

åŽå°ç®¡ç†ç•Œé¢é»˜è®¤åªæ˜¾ç¤ºæ•°æ®åº“ä¸­çš„IPï¼Œå¯èƒ½ä¼šé—æ¼UFWä¸­çš„IPã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ³•1ï¼šä»ŽUFWåŒæ­¥åˆ°æ•°æ®åº“ï¼ˆæŽ¨èï¼‰

è¿è¡ŒåŒæ­¥è„šæœ¬ï¼Œå°†UFWä¸­çš„IPå¯¼å…¥æ•°æ®åº“ï¼š

```bash
# SSHç™»å½•æœåŠ¡å™¨
ssh root@8.137.103.175

# è¿›å…¥åŽç«¯ç›®å½•
cd /www/wwwroot/backend

# è¿è¡ŒåŒæ­¥è„šæœ¬
python3 sync_ufw_to_db.py
```

**æ•ˆæžœï¼š**
- è¯»å–UFWä¸­æ‰€æœ‰è¢«DENYçš„IP
- å°†ä¸åœ¨æ•°æ®åº“ä¸­çš„IPè‡ªåŠ¨æ·»åŠ åˆ° ip_blacklist è¡¨
- æ ‡è®°ä¸º"ä»ŽUFWåŒæ­¥çš„å°ç¦IP"
- åˆ·æ–°åŽå°ç®¡ç†é¡µé¢å³å¯çœ‹åˆ°æ‰€æœ‰IP

---

### æ–¹æ³•2ï¼šå®šæ—¶è‡ªåŠ¨åŒæ­¥

æ·»åŠ åˆ°crontabï¼Œæ¯å°æ—¶è‡ªåŠ¨åŒæ­¥ä¸€æ¬¡ï¼š

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ è¿™ä¸€è¡Œï¼ˆæ¯å°æ—¶åŒæ­¥ä¸€æ¬¡ï¼‰
0 * * * * cd /www/wwwroot/backend && python3 sync_ufw_to_db.py >> /var/log/ufw_sync.log 2>&1
```

---

## ðŸ” æŸ¥çœ‹æ‰€æœ‰è¢«å°IP

### æ–¹å¼1ï¼šåŽå°ç®¡ç†ç•Œé¢

1. è®¿é—®ï¼š`http://8.137.103.175:3001/vfjsadrhbadmin`
2. ç‚¹å‡»å·¦ä¾§ **"IPç®¡ç†"**
3. å¯ä»¥çœ‹åˆ°æ‰€æœ‰è¢«å°çš„IPï¼ŒåŒ…æ‹¬ï¼š
   - åº”ç”¨ç¨‹åºå°ç¦çš„IP
   - ä»ŽUFWåŒæ­¥çš„IP
   - æ¯ä¸ªIPçš„å°ç¦åŽŸå› å’Œæ—¶é—´

### æ–¹å¼2ï¼šå‘½ä»¤è¡ŒæŸ¥çœ‹

```bash
# æŸ¥çœ‹æ•°æ®åº“ä¸­çš„å°ç¦IP
mysql -uroot -p123456 -e 'USE game_db; SELECT ip_address, reason, blocked_time FROM ip_blacklist WHERE is_active=1;'

# æŸ¥çœ‹UFWä¸­çš„å°ç¦IP  
ufw status numbered | grep DENY
```

---

## ðŸ”§ IPæ¥æºæ ‡è¯†

åŒæ­¥åŽï¼ŒåŽå°ä¼šæ˜¾ç¤ºIPå°ç¦åŽŸå› ï¼š
- `"ä»ŽUFWåŒæ­¥çš„å°ç¦IP"` - æ¥è‡ªé˜²ç«å¢™
- `"è‡ªåŠ¨å°ç¦: xxx"` - åº”ç”¨ç¨‹åºè‡ªåŠ¨å°ç¦
- `"æ‰‹åŠ¨å°ç¦"` - ç®¡ç†å‘˜æ‰‹åŠ¨æ·»åŠ 
- `"å¼‚å¸¸æ´»åŠ¨"` - æ£€æµ‹åˆ°å¼‚å¸¸è¡Œä¸º

---

## ðŸ“Š ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šç”¨æˆ·åé¦ˆè¢«å°

1. è¿›å…¥åŽå° â†’ IPç®¡ç†
2. æœç´¢ç”¨æˆ·IP
3. æŸ¥çœ‹å°ç¦åŽŸå› å’Œæ—¶é—´
4. å†³å®šæ˜¯å¦è§£å°

### åœºæ™¯2ï¼šå®šæœŸæ£€æŸ¥

1. è¿è¡Œ `python3 sync_ufw_to_db.py`
2. æŸ¥çœ‹åŽå°IPç®¡ç†
3. æ¸…ç†è¯¯å°æˆ–è¿‡æœŸçš„IP

### åœºæ™¯3ï¼šæ‰¹é‡è§£å°

```bash
# è§£å°æŸä¸ªIPï¼ˆåœ¨åŽå°ç‚¹å‡»è§£å°æŒ‰é’®ï¼‰
# æˆ–ä½¿ç”¨APIï¼š
curl -X POST http://8.137.103.175:3001/vfjsadrhbadmin/api/ip/unblock \
  -H "Content-Type: application/json" \
  -d '{"ip_address": "1.2.3.4"}'
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æƒé™é—®é¢˜**ï¼šè¿è¡Œ `ufw status` éœ€è¦rootæƒé™
2. **å•å‘åŒæ­¥**ï¼šåªä»ŽUFWåŒæ­¥åˆ°æ•°æ®åº“ï¼Œä¸ä¼šåå‘åŒæ­¥
3. **ä¸ä¼šåˆ é™¤**ï¼šåªæ·»åŠ æ–°IPï¼Œä¸ä¼šåˆ é™¤æ•°æ®åº“ä¸­å·²æœ‰çš„IP
4. **UFWè§„åˆ™ä¿ç•™**ï¼šåŒæ­¥åˆ°æ•°æ®åº“åŽï¼ŒUFWè§„åˆ™ä»ç„¶æœ‰æ•ˆ

---

## ðŸš€ å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# ä¸€é”®åŒæ­¥UFWåˆ°æ•°æ®åº“
python3 sync_ufw_to_db.py

# æŸ¥çœ‹æ•°æ®åº“è¢«å°IPæ•°é‡
mysql -uroot -p123456 -e 'USE game_db; SELECT COUNT(*) FROM ip_blacklist WHERE is_active=1;'

# æŸ¥çœ‹UFWè¢«å°IPæ•°é‡
ufw status numbered | grep -c DENY

# æ¸…ç©ºRedisç¼“å­˜ï¼ˆåŒæ­¥åŽéœ€è¦æ¸…ç©ºï¼‰
redis-cli FLUSHDB

# é‡å¯åŽç«¯æœåŠ¡
ps aux | grep "python.*start.py" | grep -v grep | awk '{print $2}' | xargs kill
cd /www/wwwroot/backend && nohup python3 start.py > /dev/null 2>&1 &
```

---

