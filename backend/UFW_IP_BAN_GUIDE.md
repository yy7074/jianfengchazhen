# ğŸ›¡ï¸ UFW é˜²ç«å¢™ - IP å°ç¦æ“ä½œæ‰‹å†Œ

**éƒ¨ç½²æ—¥æœŸ**: 2026-01-02
**çŠ¶æ€**: âœ… å·²å¯ç”¨
**å°ç¦æ–¹å¼**: UFW é˜²ç«å¢™ + iptables åŒé‡å°ç¦

---

## ğŸ“‹ **å½“å‰å·²å°ç¦çš„ IP æ®µ**

| IP æ®µ | è¯´æ˜ |
|-------|------|
| 112.82.180.0/24 | æ¶æ„åˆ·å¹¿å‘Š IP æ®µ |
| 58.216.118.0/24 | æ¶æ„åˆ·å¹¿å‘Š IP æ®µ |
| 58.216.103.0/24 | æ¶æ„åˆ·å¹¿å‘Š IP æ®µ |
| 106.8.148.0/24 | æ¶æ„åˆ·å¹¿å‘Š IP æ®µ |
| 106.8.149.0/24 | æ¶æ„åˆ·å¹¿å‘Š IP æ®µ |
| 113.137.43.0/24 | æ¶æ„åˆ·å¹¿å‘Š IP æ®µ |
| 121.14.44.0/24 | æ¶æ„åˆ·å¹¿å‘Š IP æ®µ |
| 124.236.25.0/24 | æ¶æ„åˆ·å¹¿å‘Š IP æ®µ |
| 124.236.31.0/24 | æ¶æ„åˆ·å¹¿å‘Š IP æ®µ |
| 124.236.70.0/24 | æ¶æ„åˆ·å¹¿å‘Š IP æ®µ |
| 110.249.204.0/24 | æ¶æ„åˆ·å¹¿å‘Š IP æ®µ |

---

## ğŸš€ **å¦‚ä½•æ·»åŠ æ–°çš„å°ç¦ IP**

### **æ–¹æ³•1ï¼šå°ç¦å•ä¸ª IPï¼ˆæ¨èç”¨äºæµ‹è¯•ï¼‰**

```bash
# 1. æ·»åŠ åˆ° UFW é˜²ç«å¢™
ufw insert 1 deny from 1.2.3.4

# 2. æ·»åŠ åˆ° iptables (ufw-before-input é“¾ï¼Œæœ€é«˜ä¼˜å…ˆçº§)
iptables -I ufw-before-input 1 -s 1.2.3.4 -j DROP

# 3. æ¸…é™¤è¯¥ IP çš„ç°æœ‰è¿æ¥
conntrack -D -s 1.2.3.4

# 4. ä¿å­˜è§„åˆ™ï¼ˆæŒä¹…åŒ–ï¼‰
iptables-save > /etc/iptables/rules.v4

echo "âœ… å·²å°ç¦ IP: 1.2.3.4"
```

---

### **æ–¹æ³•2ï¼šå°ç¦æ•´ä¸ª IP æ®µï¼ˆæ¨èç”¨äºæ‰¹é‡å°ç¦ï¼‰**

```bash
# å‡è®¾è¦å°ç¦ 203.0.113.0/24 æ•´ä¸ªæ®µ

# 1. æ·»åŠ åˆ° UFW é˜²ç«å¢™
ufw insert 1 deny from 203.0.113.0/24

# 2. æ·»åŠ åˆ° iptables (ufw-before-input é“¾)
iptables -I ufw-before-input 1 -s 203.0.113.0/24 -j DROP

# 3. æ¸…é™¤è¯¥ IP æ®µçš„æ‰€æœ‰ç°æœ‰è¿æ¥
conntrack -D -s 203.0.113.0/24

# 4. ä¿å­˜è§„åˆ™ï¼ˆæŒä¹…åŒ–ï¼‰
iptables-save > /etc/iptables/rules.v4

echo "âœ… å·²å°ç¦ IP æ®µ: 203.0.113.0/24"
```

---

### **æ–¹æ³•3ï¼šä¸€é”®è„šæœ¬ï¼ˆæœ€ç®€å•ï¼‰**

åˆ›å»ºè„šæœ¬æ–‡ä»¶ï¼š

```bash
cat > /root/ban_ip.sh << 'EOF'
#!/bin/bash
# ä¸€é”®å°ç¦ IP æˆ– IP æ®µ

if [ -z "$1" ]; then
    echo "ç”¨æ³•: $0 <IPåœ°å€æˆ–IPæ®µ>"
    echo "ç¤ºä¾‹: $0 1.2.3.4"
    echo "ç¤ºä¾‹: $0 203.0.113.0/24"
    exit 1
fi

IP=$1

echo "========================================="
echo "å¼€å§‹å°ç¦: $IP"
echo "========================================="

# 1. UFW å°ç¦
ufw insert 1 deny from $IP

# 2. iptables å°ç¦
iptables -I ufw-before-input 1 -s $IP -j DROP

# 3. æ¸…é™¤ç°æœ‰è¿æ¥
conntrack -D -s $IP 2>/dev/null || true

# 4. ä¿å­˜è§„åˆ™
iptables-save > /etc/iptables/rules.v4

echo ""
echo "âœ… å°ç¦å®Œæˆ: $IP"
echo ""
echo "éªŒè¯:"
ufw status numbered | head -15
EOF

chmod +x /root/ban_ip.sh
```

**ä½¿ç”¨æ–¹æ³•ï¼š**

```bash
# å°ç¦å•ä¸ª IP
/root/ban_ip.sh 1.2.3.4

# å°ç¦ IP æ®µ
/root/ban_ip.sh 203.0.113.0/24
```

---

## ğŸ” **å¦‚ä½•æŸ¥çœ‹å½“å‰å°ç¦çš„ IP**

### **æŸ¥çœ‹ UFW è§„åˆ™**

```bash
# æŸ¥çœ‹æ‰€æœ‰ UFW è§„åˆ™ï¼ˆå¸¦ç¼–å·ï¼‰
ufw status numbered

# æŸ¥çœ‹å‰ 20 æ¡è§„åˆ™
ufw status numbered | head -25
```

### **æŸ¥çœ‹ iptables è§„åˆ™**

```bash
# æŸ¥çœ‹ ufw-before-input é“¾ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
iptables -L ufw-before-input -n --line-numbers | grep DROP | head -20

# æŸ¥çœ‹ ufw-user-input é“¾
iptables -L ufw-user-input -n --line-numbers | grep DROP | head -20
```

### **æŸ¥çœ‹å·²æ‹¦æˆªçš„æ•°æ®åŒ…æ•°é‡**

```bash
# æŸ¥çœ‹æŸä¸ª IP æ®µè¢«æ‹¦æˆªçš„æ•°æ®åŒ…æ•°
iptables -L ufw-before-input -n -v | grep "112.82.180.0/24"

# è¾“å‡ºç¤ºä¾‹:
# 4524  271K DROP  0  --  *  *  112.82.180.0/24  0.0.0.0/0
# â†‘å·²æ‹¦æˆª 4524 ä¸ªæ•°æ®åŒ…
```

---

## âŒ **å¦‚ä½•è§£é™¤å°ç¦**

### **è§£é™¤å•ä¸ª IP æˆ– IP æ®µ**

```bash
# 1. æŸ¥çœ‹è§„åˆ™ç¼–å·
ufw status numbered

# å‡è®¾è¦åˆ é™¤çš„è§„åˆ™æ˜¯ç¬¬ 5 æ¡
ufw delete 5

# 2. ä» iptables åˆ é™¤
# å…ˆæŸ¥çœ‹è§„åˆ™ç¼–å·
iptables -L ufw-before-input -n --line-numbers | grep "1.2.3.4"

# å‡è®¾æ˜¯ç¬¬ 8 è¡Œ
iptables -D ufw-before-input 8

# 3. ä¿å­˜è§„åˆ™
iptables-save > /etc/iptables/rules.v4

echo "âœ… å·²è§£é™¤å°ç¦"
```

---

## ğŸ“Š **ç›‘æ§å’ŒéªŒè¯**

### **å®æ—¶æŸ¥çœ‹æ—¥å¿—**

```bash
# å®æ—¶ç›‘æ§åç«¯æ—¥å¿—ï¼ˆåº”è¯¥å¾ˆå®‰é™ï¼‰
tail -f /www/wwwlogs/python/backend/error.log

# åªçœ‹é»‘åå•æ‹¦æˆª
tail -f /www/wwwlogs/python/backend/error.log | grep "ğŸš«"

# æŒ‰ Ctrl+C åœæ­¢
```

### **ç»Ÿè®¡æ‹¦æˆªæ¬¡æ•°**

```bash
# ç»Ÿè®¡æœ€è¿‘ 100 è¡Œæ—¥å¿—ä¸­çš„é»‘åå•æ‹¦æˆªæ¬¡æ•°
tail -100 /www/wwwlogs/python/backend/error.log | grep "ğŸš«" | wc -l

# å¦‚æœæ•°å­—å¾ˆå°ï¼ˆ<10ï¼‰ï¼Œè¯´æ˜é˜²ç«å¢™å·¥ä½œæ­£å¸¸
# å¦‚æœæ•°å­—å¾ˆå¤§ï¼ˆ>50ï¼‰ï¼Œè¯´æ˜æœ‰æ–°çš„æ¶æ„ IPï¼Œéœ€è¦å°ç¦
```

### **æŸ¥çœ‹å½“å‰è¿æ¥æ•°**

```bash
# æŸ¥çœ‹ 3001 ç«¯å£çš„è¿æ¥æ•°
netstat -an | grep :3001 | grep ESTABLISHED | wc -l

# æ­£å¸¸æƒ…å†µåº”è¯¥åœ¨ 10-50 ä¸ª
```

---

## ğŸ”„ **ä»æ—¥å¿—ä¸­æ‰¾å‡ºæ–°çš„æ¶æ„ IP å¹¶å°ç¦**

### **1. æ‰¾å‡ºé¢‘ç¹è§¦å‘é»‘åå•çš„ IP**

```bash
# æŸ¥çœ‹æœ€è¿‘è¢«æ‹¦æˆªæœ€å¤šçš„ IP
tail -500 /www/wwwlogs/python/backend/error.log | grep "ğŸš«" | grep -oP '\d+\.\d+\.\d+\.\d+' | sort | uniq -c | sort -rn | head -10

# è¾“å‡ºç¤ºä¾‹:
#  25 112.82.180.220
#  18 58.216.118.60
#  12 106.8.149.146
```

### **2. æ‰¹é‡å°ç¦è¿™äº› IP**

```bash
# æ–¹æ³•1: æ‰‹åŠ¨å°ç¦æ¯ä¸ª IP æ®µ
/root/ban_ip.sh 112.82.180.220

# æ–¹æ³•2: å¦‚æœæ˜¯åŒä¸€ä¸ª C æ®µï¼Œç›´æ¥å°ç¦æ•´ä¸ªæ®µ
/root/ban_ip.sh 112.82.180.0/24
```

---

## âš™ï¸ **è§„åˆ™æŒä¹…åŒ–ï¼ˆé‡å¯åè‡ªåŠ¨åŠ è½½ï¼‰**

### **å½“å‰é…ç½®**

é˜²ç«å¢™è§„åˆ™å·²ä¿å­˜åˆ°ï¼š`/etc/iptables/rules.v4`

### **æœåŠ¡å™¨é‡å¯åè‡ªåŠ¨åŠ è½½è§„åˆ™**

å®å¡”é¢æ¿çš„ UFW ä¼šè‡ªåŠ¨åŠ è½½è§„åˆ™ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

ä½†æ˜¯ `ufw-before-input` é“¾çš„è‡ªå®šä¹‰ DROP è§„åˆ™éœ€è¦æ‰‹åŠ¨é‡æ–°æ·»åŠ ï¼Œæˆ–è€…åˆ›å»ºè‡ªåŠ¨åŠ è½½è„šæœ¬ï¼š

```bash
# åˆ›å»ºå¼€æœºè‡ªå¯è„šæœ¬
cat > /etc/rc.local << 'EOF'
#!/bin/bash
# å¼€æœºè‡ªåŠ¨åŠ è½½é˜²ç«å¢™è§„åˆ™

# åŠ è½½ iptables è§„åˆ™
if [ -f /etc/iptables/rules.v4 ]; then
    iptables-restore < /etc/iptables/rules.v4
    echo "âœ… iptables è§„åˆ™å·²åŠ è½½"
fi

exit 0
EOF

chmod +x /etc/rc.local
```

---

## ğŸš¨ **ç´§æ€¥æƒ…å†µå¤„ç†**

### **è¯¯å°äº†è‡ªå·±çš„ IP æ€ä¹ˆåŠï¼Ÿ**

1. é€šè¿‡å®å¡”é¢æ¿çš„**ç»ˆç«¯**ç™»å½•ï¼ˆä¸å—é˜²ç«å¢™å½±å“ï¼‰
2. æ‰§è¡Œè§£é™¤å°ç¦å‘½ä»¤ï¼ˆè§ä¸Šé¢çš„"å¦‚ä½•è§£é™¤å°ç¦"ç« èŠ‚ï¼‰

### **é˜²ç«å¢™è§„åˆ™å¯¼è‡´æœåŠ¡å™¨æ— æ³•è®¿é—®ï¼Ÿ**

```bash
# ä¸´æ—¶å…³é—­ UFW
ufw disable

# æŸ¥çœ‹æ˜¯å¦æ¢å¤æ­£å¸¸
# å¦‚æœæ­£å¸¸ï¼Œè¯´æ˜æ˜¯ UFW è§„åˆ™é—®é¢˜

# é‡æ–°å¯ç”¨ UFW
ufw enable
```

### **æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰é˜²ç«å¢™è§„åˆ™**

```bash
# âš ï¸ è°¨æ…æ“ä½œï¼è¿™ä¼šåˆ é™¤æ‰€æœ‰è‡ªå®šä¹‰è§„åˆ™

# é‡ç½® UFW
ufw --force reset

# æ¸…ç©º iptables
iptables -F
iptables -X

# é‡æ–°æ·»åŠ åŸºç¡€è§„åˆ™
ufw allow 22
ufw allow 80
ufw allow 443
ufw allow 3001
ufw enable
```

---

## ğŸ“ **å¸¸è§é—®é¢˜ FAQ**

### **Q1: ä¸ºä»€ä¹ˆè¦åŒæ—¶ä½¿ç”¨ UFW å’Œ iptablesï¼Ÿ**

A: UFW è§„åˆ™ä¼˜å…ˆçº§é«˜ï¼Œä½† `ufw-before-input` é“¾ä¸­çš„ `ESTABLISHED` è¿æ¥ä¼šè¢«æ”¾è¡Œã€‚æ‰€ä»¥éœ€è¦åœ¨ `ufw-before-input` é“¾æœ€å‰é¢æ’å…¥ iptables DROP è§„åˆ™ï¼Œæ‰èƒ½å®Œå…¨å°ç¦ã€‚

### **Q2: å°ç¦åå¤šä¹…ç”Ÿæ•ˆï¼Ÿ**

A: ç«‹å³ç”Ÿæ•ˆï¼ä½†å·²å»ºç«‹çš„è¿æ¥éœ€è¦ç”¨ `conntrack -D` æ¸…é™¤ã€‚

### **Q3: ä¼šä¸ä¼šè¯¯ä¼¤æ­£å¸¸ç”¨æˆ·ï¼Ÿ**

A: ä¸ä¼šã€‚æˆ‘ä»¬åªå°ç¦æ•°æ®åº“é»‘åå•ä¸­çš„æ¶æ„ IPã€‚æ­£å¸¸ç”¨æˆ·ä¸å—å½±å“ã€‚

### **Q4: å¦‚ä½•ç¡®è®¤å°ç¦æˆåŠŸï¼Ÿ**

A:
1. æŸ¥çœ‹æ—¥å¿—ï¼Œè¯¥ IP ä¸å†å‡ºç°
2. æŸ¥çœ‹ UFW ç»Ÿè®¡ï¼Œæ‹¦æˆªæ•°æ®åŒ…æ•°åœ¨å¢åŠ 
3. æœåŠ¡å™¨è´Ÿè½½ä¸‹é™ï¼Œç®¡ç†åå°é€Ÿåº¦æå‡

---

## âœ… **æœ€ä½³å®è·µå»ºè®®**

1. **æ¯å¤©æ£€æŸ¥ä¸€æ¬¡æ—¥å¿—**ï¼Œæ‰¾å‡ºæ–°çš„æ¶æ„ IP
2. **å°ç¦æ•´ä¸ª IP æ®µ**ï¼ˆ/24ï¼‰ï¼Œè€Œä¸æ˜¯å•ä¸ª IPï¼ˆå› ä¸ºæ”»å‡»è€…ä¼šæ¢ IPï¼‰
3. **å®šæœŸå¤‡ä»½è§„åˆ™**ï¼š`iptables-save > /root/iptables_backup_$(date +%Y%m%d).rules`
4. **ç›‘æ§æœåŠ¡å™¨è´Ÿè½½**ï¼Œå¦‚æœ CPU é«˜ï¼Œå¯èƒ½æœ‰æ–°çš„æ”»å‡»
5. **ä¿ç•™æ—¥å¿—è®°å½•**ï¼Œä¾¿äºåç»­åˆ†ææ”»å‡»æ¨¡å¼

---

**éƒ¨ç½²å®Œæˆæ—¶é—´**: 2026-01-02
**ç»´æŠ¤äºº**: Claude Code
**æœ€åæ›´æ–°**: 2026-01-02
