# ğŸ”„ è‡ªåŠ¨åŒæ­¥é˜²ç«å¢™ - ä½¿ç”¨æ–‡æ¡£

**åŠŸèƒ½**: è‡ªåŠ¨ä»æ•°æ®åº“è¯»å–é»‘åå•IPå¹¶åŒæ­¥åˆ°é˜²ç«å¢™
**éƒ¨ç½²æ—¶é—´**: 2026-01-02
**çŠ¶æ€**: âœ… å·²éƒ¨ç½²

---

## ğŸ¯ **åŠŸèƒ½è¯´æ˜**

å½“ä½ åœ¨**ç®¡ç†åå°**å°ç¦IPåï¼Œè¿™ä¸ªè„šæœ¬ä¼š**è‡ªåŠ¨**ï¼š

1. âœ… ä»æ•°æ®åº“ `ip_blacklist` è¡¨è¯»å–æ‰€æœ‰æ´»è·ƒçš„é»‘åå•IP
2. âœ… è‡ªåŠ¨å°†IPè½¬æ¢ä¸ºå­ç½‘æ®µï¼ˆ/24ï¼‰ï¼Œä¾‹å¦‚ `112.82.180.220` â†’ `112.82.180.0/24`
3. âœ… æ·»åŠ åˆ° **UFW é˜²ç«å¢™**
4. âœ… æ·»åŠ åˆ° **iptables** è§„åˆ™ï¼ˆ`ufw-before-input` é“¾ï¼Œæœ€é«˜ä¼˜å…ˆçº§ï¼‰
5. âœ… æ¸…é™¤è¯¥IPçš„æ‰€æœ‰ç°æœ‰è¿æ¥
6. âœ… ä¿å­˜è§„åˆ™åˆ° `/etc/iptables/rules.v4`ï¼ˆæŒä¹…åŒ–ï¼‰

**ä½ ä¸éœ€è¦æ‰‹åŠ¨æ“ä½œä»»ä½•é˜²ç«å¢™å‘½ä»¤ï¼**

---

## ğŸ“¦ **ä¸€é”®éƒ¨ç½²**

### **åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š**

```bash
# è¿›å…¥backendç›®å½•
cd /www/wwwroot/backend

# ä¸Šä¼ æ–‡ä»¶åï¼Œæ‰§è¡Œå®‰è£…è„šæœ¬
sudo bash install_auto_sync.sh
```

å®‰è£…å®Œæˆåï¼Œè„šæœ¬ä¼šï¼š
- âœ… å®‰è£…Pythonä¾èµ–
- âœ… åˆ›å»ºsystemdåå°æœåŠ¡
- âœ… åˆ›å»ºcronå®šæ—¶ä»»åŠ¡
- âœ… æ‰§è¡Œä¸€æ¬¡åˆå§‹åŒæ­¥

---

## ğŸš€ **ä½¿ç”¨æ–¹å¼**

### **æ–¹å¼1ï¼šåå°æœåŠ¡ï¼ˆæ¨èï¼‰â­**

å®æ—¶ç›‘æ§æ•°æ®åº“ï¼Œæ¯60ç§’æ£€æŸ¥ä¸€æ¬¡æ–°å¢çš„é»‘åå•IPã€‚

```bash
# å¯åŠ¨æœåŠ¡
systemctl start firewall-sync

# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
systemctl status firewall-sync

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
journalctl -u firewall-sync -f

# åœæ­¢æœåŠ¡
systemctl stop firewall-sync

# è®¾ç½®å¼€æœºè‡ªå¯
systemctl enable firewall-sync
```

---

### **æ–¹å¼2ï¼šå®šæ—¶ä»»åŠ¡ï¼ˆå·²è‡ªåŠ¨é…ç½®ï¼‰**

æ¯5åˆ†é’Ÿè‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡åŒæ­¥ã€‚

```bash
# æŸ¥çœ‹cronä»»åŠ¡
crontab -l

# æŸ¥çœ‹åŒæ­¥æ—¥å¿—
tail -f /var/log/firewall-sync.log

# æ‰‹åŠ¨ç¼–è¾‘é—´éš”ï¼ˆå¦‚æœéœ€è¦ï¼‰
crontab -e
```

---

### **æ–¹å¼3ï¼šæ‰‹åŠ¨æ‰§è¡Œ**

```bash
# æ‰§è¡Œä¸€æ¬¡åŒæ­¥
python3 /usr/local/bin/auto_sync_firewall.py --mode once

# æŒç»­ç›‘æ§æ¨¡å¼ï¼ˆæŒ‰Ctrl+Cåœæ­¢ï¼‰
python3 /usr/local/bin/auto_sync_firewall.py --mode watch --interval 60

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
python3 /usr/local/bin/auto_sync_firewall.py --mode stats
```

---

## ğŸ“Š **æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯**

```bash
# æŸ¥çœ‹å°ç¦ç»Ÿè®¡
python3 /usr/local/bin/auto_sync_firewall.py --mode stats
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
============================================================
ğŸ“Š é˜²ç«å¢™å°ç¦ç»Ÿè®¡
============================================================
æ•°æ®åº“é»‘åå•IPæ•°é‡: 68
é˜²ç«å¢™å·²å°ç¦IPæ®µ: 11
UFWè§„åˆ™æ•°é‡: 11
å·²æ‹¦æˆªæ•°æ®åŒ…: 15234
============================================================

æœ€è¿‘å°ç¦çš„IPæ®µï¼ˆå‰10ä¸ªï¼‰:
  - 112.82.180.0/24
  - 58.216.118.0/24
  - 58.216.103.0/24
  - 106.8.148.0/24
  - 106.8.149.0/24
  ...
```

---

## ğŸ” **å·¥ä½œåŸç†**

### **1. è‡ªåŠ¨è½¬æ¢ä¸ºå­ç½‘æ®µ**

è„šæœ¬ä¼šæ™ºèƒ½åœ°å°†å•ä¸ªIPè½¬æ¢ä¸ºæ•´ä¸ªCæ®µå­ç½‘ï¼š

| æ•°æ®åº“ä¸­çš„IP | é˜²ç«å¢™å°ç¦çš„å­ç½‘ |
|-------------|----------------|
| 112.82.180.220 | 112.82.180.0/24 |
| 112.82.180.225 | 112.82.180.0/24ï¼ˆå»é‡ï¼‰|
| 58.216.118.60 | 58.216.118.0/24 |

**å¥½å¤„**ï¼š
- âœ… å°ç¦æ•ˆç‡æ›´é«˜ï¼ˆä¸€æ¬¡å°ç¦256ä¸ªIPï¼‰
- âœ… é˜²æ­¢æ”»å‡»è€…æ¢IPï¼ˆåŒä¸€æ®µå†…æ¢IPä¹Ÿæ— æ•ˆï¼‰
- âœ… è§„åˆ™æ•°é‡å°‘ï¼Œæ€§èƒ½æ›´å¥½

### **2. åŒé‡å°ç¦æœºåˆ¶**

```
UFWè§„åˆ™ (ç”¨æˆ·å±‚)
    â†“
iptables ufw-before-input (å†…æ ¸å±‚ï¼Œæœ€é«˜ä¼˜å…ˆçº§)
    â†“
é˜»æ­¢æ‰€æœ‰æ¥è‡ªè¯¥IPæ®µçš„æ•°æ®åŒ…
```

### **3. é¿å…é‡å¤å°ç¦**

è„šæœ¬ä¼šè®°å½•å·²å°ç¦çš„IPæ®µåˆ°æ–‡ä»¶ï¼š`/tmp/firewall_banned_ips.txt`

æ¯æ¬¡è¿è¡Œæ—¶åªå°ç¦**æ–°å¢çš„**IPæ®µï¼Œé¿å…é‡å¤æ“ä½œã€‚

---

## ğŸ“ **æ—¥å¿—ä½ç½®**

### **systemdæœåŠ¡æ—¥å¿—**
```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
journalctl -u firewall-sync -f

# æŸ¥çœ‹æœ€è¿‘100è¡Œæ—¥å¿—
journalctl -u firewall-sync -n 100

# æŸ¥çœ‹ä»Šå¤©çš„æ—¥å¿—
journalctl -u firewall-sync --since today
```

### **cronä»»åŠ¡æ—¥å¿—**
```bash
# æŸ¥çœ‹åŒæ­¥æ—¥å¿—
tail -f /var/log/firewall-sync.log

# æŸ¥çœ‹æœ€è¿‘çš„åŒæ­¥è®°å½•
tail -100 /var/log/firewall-sync.log
```

---

## ğŸ§ª **æµ‹è¯•æµç¨‹**

### **1. åœ¨ç®¡ç†åå°å°ç¦ä¸€ä¸ªæ–°çš„IP**

ä¾‹å¦‚ï¼šå°ç¦ `203.0.113.45`

### **2. ç­‰å¾…è„šæœ¬è‡ªåŠ¨åŒæ­¥**

- **æ–¹å¼1ï¼ˆsystemdæœåŠ¡ï¼‰**ï¼šæœ€å¤šç­‰å¾…60ç§’
- **æ–¹å¼2ï¼ˆcronä»»åŠ¡ï¼‰**ï¼šæœ€å¤šç­‰å¾…5åˆ†é’Ÿ

æˆ–è€…æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ï¼š
```bash
python3 /usr/local/bin/auto_sync_firewall.py --mode once
```

### **3. éªŒè¯æ˜¯å¦å°ç¦æˆåŠŸ**

```bash
# æŸ¥çœ‹UFWè§„åˆ™
ufw status numbered | grep "203.0.113.0/24"

# æŸ¥çœ‹iptablesè§„åˆ™
iptables -L ufw-before-input -n | grep "203.0.113.0/24"

# å¦‚æœæœ‰è¾“å‡ºï¼Œè¯´æ˜å°ç¦æˆåŠŸ
```

---

## âš™ï¸ **é…ç½®ä¿®æ”¹**

### **ä¿®æ”¹æ£€æŸ¥é—´éš”**

**systemdæœåŠ¡ï¼ˆ60ç§’ï¼‰ï¼š**

ç¼–è¾‘æœåŠ¡é…ç½®ï¼š
```bash
vim /etc/systemd/system/firewall-sync.service
```

ä¿®æ”¹è¿™è¡Œï¼š
```ini
ExecStart=/usr/bin/python3 /usr/local/bin/auto_sync_firewall.py --mode watch --interval 60
```

æ”¹ä¸ºï¼ˆä¾‹å¦‚30ç§’ï¼‰ï¼š
```ini
ExecStart=/usr/bin/python3 /usr/local/bin/auto_sync_firewall.py --mode watch --interval 30
```

é‡å¯æœåŠ¡ï¼š
```bash
systemctl daemon-reload
systemctl restart firewall-sync
```

**cronä»»åŠ¡ï¼ˆ5åˆ†é’Ÿï¼‰ï¼š**

ç¼–è¾‘cronï¼š
```bash
crontab -e
```

ä¿®æ”¹ï¼š
```cron
# ä»æ¯5åˆ†é’Ÿæ”¹ä¸ºæ¯2åˆ†é’Ÿ
*/2 * * * * /usr/bin/python3 /usr/local/bin/auto_sync_firewall.py --mode once >> /var/log/firewall-sync.log 2>&1
```

---

### **ä¿®æ”¹æ•°æ®åº“é…ç½®**

ç¼–è¾‘è„šæœ¬ï¼š
```bash
vim /usr/local/bin/auto_sync_firewall.py
```

ä¿®æ”¹è¿™éƒ¨åˆ†ï¼š
```python
DB_CONFIG = {
    'host': 'localhost',
    'port': 3306,
    'user': 'root',
    'password': 'SJKdjksal652',
    'database': 'game_db'
}
```

---

## ğŸš¨ **æ•…éšœæ’æŸ¥**

### **é—®é¢˜1ï¼šè„šæœ¬æ²¡æœ‰è‡ªåŠ¨åŒæ­¥**

**æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š**
```bash
systemctl status firewall-sync
```

å¦‚æœæ˜¾ç¤º `inactive (dead)`ï¼Œå¯åŠ¨æœåŠ¡ï¼š
```bash
systemctl start firewall-sync
```

**æŸ¥çœ‹é”™è¯¯æ—¥å¿—ï¼š**
```bash
journalctl -u firewall-sync -n 50
```

---

### **é—®é¢˜2ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥**

**é”™è¯¯ä¿¡æ¯ï¼š** `âŒ æŸ¥è¯¢æ•°æ®åº“å¤±è´¥`

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥æ•°æ®åº“å¯†ç æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥MySQLæœåŠ¡æ˜¯å¦è¿è¡Œï¼š`systemctl status mysql`
3. æ£€æŸ¥pymysqlæ˜¯å¦å®‰è£…ï¼š`pip3 show pymysql`

---

### **é—®é¢˜3ï¼šæƒé™ä¸è¶³**

**é”™è¯¯ä¿¡æ¯ï¼š** `âŒ æ­¤è„šæœ¬éœ€è¦rootæƒé™è¿è¡Œ`

**è§£å†³æ–¹æ³•ï¼š**
```bash
# ä½¿ç”¨sudoè¿è¡Œ
sudo python3 /usr/local/bin/auto_sync_firewall.py --mode once
```

---

## ğŸ”„ **å¸è½½**

```bash
# åœæ­¢å¹¶åˆ é™¤systemdæœåŠ¡
systemctl stop firewall-sync
systemctl disable firewall-sync
rm /etc/systemd/system/firewall-sync.service
systemctl daemon-reload

# åˆ é™¤cronä»»åŠ¡
crontab -e
# åˆ é™¤åŒ…å« auto_sync_firewall.py çš„é‚£ä¸€è¡Œ

# åˆ é™¤è„šæœ¬æ–‡ä»¶
rm /usr/local/bin/auto_sync_firewall.py

# åˆ é™¤è®°å½•æ–‡ä»¶
rm /tmp/firewall_banned_ips.txt

# åˆ é™¤æ—¥å¿—
rm /var/log/firewall-sync.log
```

---

## ğŸ’¡ **æœ€ä½³å®è·µ**

1. **æ¨èä½¿ç”¨systemdæœåŠ¡ï¼ˆæ–¹å¼1ï¼‰**
   - å®æ—¶ç›‘æ§ï¼Œå“åº”æ›´å¿«
   - è‡ªåŠ¨é‡å¯ï¼Œæ›´ç¨³å®š
   - æ—¥å¿—ç®¡ç†æ›´æ–¹ä¾¿

2. **å®šæœŸæ£€æŸ¥æ—¥å¿—**
   ```bash
   journalctl -u firewall-sync --since "1 hour ago"
   ```

3. **æ¯å‘¨æŸ¥çœ‹ä¸€æ¬¡ç»Ÿè®¡ä¿¡æ¯**
   ```bash
   python3 /usr/local/bin/auto_sync_firewall.py --mode stats
   ```

4. **å¤‡ä»½é˜²ç«å¢™è§„åˆ™**
   ```bash
   iptables-save > /root/iptables_backup_$(date +%Y%m%d).rules
   ```

---

## âœ… **éƒ¨ç½²æ£€æŸ¥æ¸…å•**

- [ ] è„šæœ¬å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
- [ ] æ‰§è¡Œäº† `install_auto_sync.sh`
- [ ] systemdæœåŠ¡æ­£åœ¨è¿è¡Œï¼ˆ`systemctl status firewall-sync`ï¼‰
- [ ] æ‰§è¡Œäº†ä¸€æ¬¡æ‰‹åŠ¨åŒæ­¥æµ‹è¯•
- [ ] åœ¨ç®¡ç†åå°å°ç¦ä¸€ä¸ªæµ‹è¯•IPï¼ŒéªŒè¯è‡ªåŠ¨åŒæ­¥
- [ ] æ£€æŸ¥é˜²ç«å¢™è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆï¼ˆ`ufw status numbered`ï¼‰
- [ ] è®¾ç½®å¼€æœºè‡ªå¯ï¼ˆ`systemctl enable firewall-sync`ï¼‰

---

**éƒ¨ç½²å®Œæˆï¼ç°åœ¨ä½ åªéœ€è¦åœ¨ç®¡ç†åå°å°ç¦IPï¼Œè„šæœ¬ä¼šè‡ªåŠ¨å¤„ç†ä¸€åˆ‡ï¼** ğŸ‰
