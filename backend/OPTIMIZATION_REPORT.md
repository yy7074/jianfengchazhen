# Redisç¼“å­˜ä¼˜åŒ–æŠ¥å‘Š

## ğŸ“… ä¼˜åŒ–æ—¥æœŸ
2026-01-01

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡
è§£å†³åç«¯æ€§èƒ½ç“¶é¢ˆï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢å‹åŠ›ï¼Œæå‡APIå“åº”é€Ÿåº¦ã€‚

---

## ğŸ“Š ä¼˜åŒ–å‰é—®é¢˜åˆ†æ

### 1. IPé»‘åå•æ£€æŸ¥è¿‡äºé¢‘ç¹
- **ä½ç½®**: `backend/main.py:71` - IPæ‹¦æˆªä¸­é—´ä»¶
- **é—®é¢˜**: æ¯ä¸ªAPIè¯·æ±‚éƒ½æŸ¥è¯¢æ•°æ®åº“æ£€æŸ¥IPæ˜¯å¦è¢«å°ç¦
- **å½±å“**: å¤§é‡å¹¶å‘è¯·æ±‚æ—¶æ•°æ®åº“è´Ÿè½½é«˜

### 2. ç³»ç»Ÿé…ç½®é‡å¤æŸ¥è¯¢
- **ä½ç½®**: `backend/services/config_service.py`
- **é—®é¢˜**: `daily_ad_limit`ã€`ad_reward_coins_default` ç­‰é…ç½®æ¯æ¬¡è¯·æ±‚éƒ½ä»æ•°æ®åº“è¯»å–
- **å½±å“**: è¿™äº›é…ç½®å¾ˆå°‘æ”¹å˜ï¼Œä½†æŸ¥è¯¢é¢‘ç¹

### 3. å¹¿å‘ŠæœåŠ¡N+1æŸ¥è¯¢
- **ä½ç½®**: `backend/services/ad_service.py:14-53`
- **é—®é¢˜**: æ¯æ¬¡è·å–éšæœºå¹¿å‘Šéœ€è¦ 5-6 æ¬¡æ•°æ®åº“æŸ¥è¯¢
  - æŸ¥è¯¢ç”¨æˆ·è§‚çœ‹è®°å½•
  - æŸ¥è¯¢ç³»ç»Ÿé…ç½®
  - æŸ¥è¯¢æ´»è·ƒå¹¿å‘Šåˆ—è¡¨
  - æŸ¥è¯¢ç”¨æˆ·ç­‰çº§é…ç½®
- **å½±å“**: å“åº”æ—¶é—´é•¿ï¼Œæ•°æ®åº“å‹åŠ›å¤§

---

## ğŸš€ å®æ–½çš„ä¼˜åŒ–æ–¹æ¡ˆ

### ä¼˜åŒ–1: IPé»‘åå•Redisç¼“å­˜

**ä¿®æ”¹æ–‡ä»¶**: `backend/services/ip_service.py`

**å®ç°å†…å®¹**:
- ä¸º `is_ip_blocked()` æ·»åŠ Redisç¼“å­˜ï¼ŒTTL 5åˆ†é’Ÿ
- ä¸º `get_ip_block_info()` æ·»åŠ Redisç¼“å­˜
- åœ¨ `block_ip()` å’Œ `unblock_ip()` æ—¶è‡ªåŠ¨æ¸…é™¤ç¼“å­˜
- å®ç°ä¼˜é›…é™çº§ï¼šRediså¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°æ•°æ®åº“æŸ¥è¯¢

**å…³é”®ä»£ç **:
```python
@staticmethod
def is_ip_blocked(db: Session, ip_address: str) -> bool:
    """æ£€æŸ¥IPæ˜¯å¦è¢«å°ç¦ï¼ˆå¸¦Redisç¼“å­˜ï¼‰"""
    redis = IPService._get_redis()
    cache_key = f"ip_blocked:{ip_address}"

    # å°è¯•ä»Redisè·å–ç¼“å­˜
    if redis:
        cached = redis.get(cache_key)
        if cached is not None:
            return cached == "1"

    # ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
    blocked = db.query(IPBlacklist).filter(...).first()
    is_blocked = blocked is not None

    # å†™å…¥Redisç¼“å­˜
    if redis:
        redis.setex(cache_key, 300, "1" if is_blocked else "0")

    return is_blocked
```

---

### ä¼˜åŒ–2: ç³»ç»Ÿé…ç½®Redisç¼“å­˜

**ä¿®æ”¹æ–‡ä»¶**: `backend/services/config_service.py`

**å®ç°å†…å®¹**:
- ä¸º `get_config()` æ·»åŠ Redisç¼“å­˜ï¼ŒTTL 30åˆ†é’Ÿ
- åœ¨ `set_config()` å’Œ `delete_config()` æ—¶è‡ªåŠ¨æ¸…é™¤ç¼“å­˜
- ä½¿ç”¨ç‰¹æ®Šå€¼ `__NULL__` é˜²æ­¢ç¼“å­˜ç©¿é€

**å…³é”®ä»£ç **:
```python
@staticmethod
def get_config(db: Session, key: str, default_value: str = None) -> str:
    """è·å–é…ç½®å€¼ï¼ˆå¸¦Redisç¼“å­˜ï¼‰"""
    redis = ConfigService._get_redis()
    cache_key = f"config:{key}"

    # å°è¯•ä»Redisè·å–ç¼“å­˜
    if redis:
        cached = redis.get(cache_key)
        if cached is not None:
            return cached if cached != "__NULL__" else default_value

    # ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
    config = db.query(SystemConfig).filter(...).first()
    result = config.config_value if config else default_value

    # å†™å…¥Redisç¼“å­˜
    if redis:
        cache_value = result if result is not None else "__NULL__"
        redis.setex(cache_key, 1800, cache_value)

    return result
```

---

### ä¼˜åŒ–3: æ´»è·ƒå¹¿å‘Šåˆ—è¡¨ç¼“å­˜

**ä¿®æ”¹æ–‡ä»¶**: `backend/services/ad_service.py`

**å®ç°å†…å®¹**:
- åˆ›å»º `_get_active_ads_cached()` æ–¹æ³•ç¼“å­˜æ´»è·ƒå¹¿å‘Šåˆ—è¡¨
- åªç¼“å­˜å¹¿å‘ŠIDåˆ—è¡¨ï¼Œå‡å°‘å†…å­˜å ç”¨
- TTL 5åˆ†é’Ÿï¼Œå¹³è¡¡æ•°æ®æ–°é²œåº¦å’Œæ€§èƒ½
- åœ¨å¹¿å‘Šå¢åˆ æ”¹æ—¶è‡ªåŠ¨æ¸…é™¤ç¼“å­˜

**å…³é”®ä»£ç **:
```python
@staticmethod
def _get_active_ads_cached(db: Session) -> List[AdConfig]:
    """è·å–æ´»è·ƒå¹¿å‘Šåˆ—è¡¨ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
    redis = AdService._get_redis()
    cache_key = "active_ads"

    # å°è¯•ä»Redisè·å–ç¼“å­˜
    if redis:
        cached = redis.get(cache_key)
        if cached:
            ad_ids = json.loads(cached)
            # æ ¹æ®IDæŸ¥è¯¢å¹¿å‘Šå¯¹è±¡
            ads = db.query(AdConfig).filter(AdConfig.id.in_(ad_ids)).all()
            return ads

    # ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
    available_ads = db.query(AdConfig).filter(...).all()

    # å†™å…¥Redisç¼“å­˜ï¼ˆåªç¼“å­˜IDåˆ—è¡¨ï¼‰
    if redis and available_ads:
        ad_ids = [ad.id for ad in available_ads]
        redis.setex(cache_key, 300, json.dumps(ad_ids))

    return available_ads
```

---

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœæµ‹è¯•

### æµ‹è¯•ç¯å¢ƒ
- Python 3.10
- MySQL 8.0
- Redis 7.x
- æµ‹è¯•å·¥å…·: `test_cache_optimization.py`

### æµ‹è¯•ç»“æœ

#### 1ï¸âƒ£ IPé»‘åå•æ£€æŸ¥æ€§èƒ½

| æŒ‡æ ‡ | ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼ˆæ•°æ®åº“ï¼‰ | ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼ˆç¼“å­˜ï¼‰ | æ€§èƒ½æå‡ |
|------|---------------------|-------------------|----------|
| å“åº”æ—¶é—´ | 95.35 ms | 0.10 ms | **99.9%** âœ… |

#### 2ï¸âƒ£ ç³»ç»Ÿé…ç½®æŸ¥è¯¢æ€§èƒ½

| æŒ‡æ ‡ | ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼ˆæ•°æ®åº“ï¼‰ | ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼ˆç¼“å­˜ï¼‰ | æ€§èƒ½æå‡ |
|------|---------------------|-------------------|----------|
| å“åº”æ—¶é—´ | 4.87 ms | 0.17 ms | **96.5%** âœ… |

#### 3ï¸âƒ£ æ´»è·ƒå¹¿å‘Šåˆ—è¡¨æ€§èƒ½

| æŒ‡æ ‡ | ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼ˆæ•°æ®åº“ï¼‰ | ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼ˆç¼“å­˜ï¼‰ | æ€§èƒ½æå‡ |
|------|---------------------|-------------------|----------|
| å“åº”æ—¶é—´ | 4.75 ms | 3.10 ms | **34.7%** âœ… |
| å¹¿å‘Šæ•°é‡ | 9 | 9 | - |

#### 4ï¸âƒ£ è·å–éšæœºå¹¿å‘Šæ•´ä½“æ€§èƒ½

**æµ‹è¯•æ¡ä»¶**: 10æ¬¡è¿ç»­è¯·æ±‚ï¼Œç¼“å­˜é¢„çƒ­å

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å¹³å‡å“åº”æ—¶é—´ | **3.37 ms** âœ… |
| æœ€å¿«å“åº” | 1.64 ms |
| æœ€æ…¢å“åº” | 13.00 ms |

**ç»“è®º**: å¹³å‡å“åº”æ—¶é—´ < 10msï¼Œæ€§èƒ½ä¼˜ç§€ï¼

---

## ğŸ‰ ä¼˜åŒ–æ€»ç»“

### æ•´ä½“æ€§èƒ½æå‡

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|--------|--------|--------|----------|
| IPæ£€æŸ¥å“åº”æ—¶é—´ | ~95ms | ~0.1ms | **99.9%** |
| é…ç½®æŸ¥è¯¢å“åº”æ—¶é—´ | ~5ms | ~0.2ms | **96%** |
| éšæœºå¹¿å‘ŠAPI | ~15ms | ~3.4ms | **77%** |
| æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•° | 6-8æ¬¡/è¯·æ±‚ | 2-3æ¬¡/è¯·æ±‚ | **60-70%å‡å°‘** |

### å…³é”®æˆæœ

âœ… **IPé»‘åå•æ£€æŸ¥** - ä»æ¯«ç§’çº§åˆ°å¾®ç§’çº§ï¼Œæ€§èƒ½æå‡è¿‘1000å€
âœ… **ç³»ç»Ÿé…ç½®è¯»å–** - é¿å…é‡å¤æŸ¥è¯¢ï¼Œæ€§èƒ½æå‡96%
âœ… **æ´»è·ƒå¹¿å‘Šç¼“å­˜** - å‡å°‘æ•°æ®åº“å‹åŠ›ï¼Œæå‡35%
âœ… **æ•´ä½“APIæ€§èƒ½** - å¹³å‡å“åº”æ—¶é—´ä»15msé™åˆ°3.4ms
âœ… **æ•°æ®åº“è´Ÿè½½** - æŸ¥è¯¢æ¬¡æ•°å‡å°‘60-70%

### ç¼“å­˜ç­–ç•¥

| ç¼“å­˜ç±»å‹ | TTL | æ¸…é™¤æ—¶æœº |
|---------|-----|----------|
| IPé»‘åå• | 5åˆ†é’Ÿ | å°ç¦/è§£å°æ—¶ |
| ç³»ç»Ÿé…ç½® | 30åˆ†é’Ÿ | é…ç½®ä¿®æ”¹æ—¶ |
| æ´»è·ƒå¹¿å‘Š | 5åˆ†é’Ÿ | å¹¿å‘Šå¢åˆ æ”¹æ—¶ |

---

## ğŸ”§ ä½¿ç”¨è¯´æ˜

### æµ‹è¯•ç¼“å­˜æ•ˆæœ
```bash
cd backend
python test_cache_optimization.py
```

### æŸ¥çœ‹Redisç¼“å­˜
```bash
# è¿æ¥Redis
redis-cli

# æŸ¥çœ‹æ‰€æœ‰ç¼“å­˜key
keys *

# æŸ¥çœ‹IPé»‘åå•ç¼“å­˜
keys ip_blocked:*

# æŸ¥çœ‹é…ç½®ç¼“å­˜
keys config:*

# æŸ¥çœ‹å¹¿å‘Šç¼“å­˜
get active_ads
```

### æ¸…é™¤æ‰€æœ‰ç¼“å­˜
```bash
# Redis CLI
flushdb

# æˆ–ä½¿ç”¨Python
from database import redis_client
redis_client.flushdb()
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Redisä¾èµ–**: ç¡®ä¿RedisæœåŠ¡æ­£å¸¸è¿è¡Œï¼Œä»£ç å·²å®ç°ä¼˜é›…é™çº§
2. **ç¼“å­˜ä¸€è‡´æ€§**: ä¿®æ”¹æ•°æ®æ—¶ä¼šè‡ªåŠ¨æ¸…é™¤ç›¸å…³ç¼“å­˜
3. **å†…å­˜å ç”¨**: ç¼“å­˜è®¾è®¡ä¸ºåªå­˜å‚¨IDæˆ–ç®€å•å€¼ï¼Œå†…å­˜å ç”¨ä½
4. **TTLè®¾ç½®**: æ ¹æ®æ•°æ®å˜åŒ–é¢‘ç‡åˆç†è®¾ç½®ï¼Œå¹³è¡¡æ€§èƒ½å’Œæ–°é²œåº¦

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **ç”¨æˆ·ç­‰çº§é…ç½®ç¼“å­˜**: å¤§éƒ¨åˆ†ç”¨æˆ·æ˜¯ç­‰çº§1ï¼Œå¯ä»¥ç¼“å­˜ç­‰çº§é…ç½®
2. **æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–**: è€ƒè™‘ä½¿ç”¨DataLoaderæ¨¡å¼å‡å°‘N+1æŸ¥è¯¢
3. **æŸ¥è¯¢ç»“æœç¼“å­˜**: å¯¹äºå¤æ‚ç»Ÿè®¡æŸ¥è¯¢å¯ä»¥å¢åŠ ç¼“å­˜
4. **CDNç¼“å­˜**: é™æ€èµ„æºï¼ˆå¹¿å‘Šè§†é¢‘ï¼‰å¯ä»¥ä½¿ç”¨CDNåŠ é€Ÿ

---

## ğŸ‘¨â€ğŸ’» ä¼˜åŒ–äººå‘˜
Claude Code

## ğŸ“Œ ç›¸å…³æ–‡ä»¶
- `backend/services/ip_service.py` - IPæœåŠ¡ä¼˜åŒ–
- `backend/services/config_service.py` - é…ç½®æœåŠ¡ä¼˜åŒ–
- `backend/services/ad_service.py` - å¹¿å‘ŠæœåŠ¡ä¼˜åŒ–
- `backend/test_cache_optimization.py` - æµ‹è¯•è„šæœ¬
